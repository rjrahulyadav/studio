/**
 * @fileoverview Firestore Security Rules for the Training Application
 * @author an AI Security Architect
 * @version 1.3
 *
 * @description
 * This ruleset is designed for a training application where modules are publicly
 * visible, but submitting applications and viewing applicant data is restricted.
 * The rules facilitate rapid prototyping by enforcing strict authorization without
 * validating the full data schema.
 *
 * Core Philosophy:
 * The security model follows a principle of "public read, restricted write."
 * Training modules are public information, accessible to everyone.
 * Applying for a module requires authentication to prevent anonymous spam.
 * Viewing applicant data is a privileged operation reserved for a hardcoded
 * admin UID.
 *
 * Data Structure:
 * - /trainingModules/{trainingModuleId}: A top-level collection containing public
 *   information about each training course.
 * - /trainingModules/{trainingModuleId}/applicants/{applicantId}: A subcollection
 *   where each document represents a single application for the parent training
 *   module. This structure namespaces applications per module.
 *
 * Key Security Decisions:
 * 1. Admin Role via Hardcoded UID: An 'admin' role is implemented by checking
 *    against a specific user ID (`request.auth.uid`). This provides a
 *    secure, though less flexible, way to manage administrative privileges.
 * 2. Immutable Applications: To protect applicant data integrity and because
 *    there is no user ownership field on an application, applicants cannot modify
 *    or delete their applications after submission. These actions are assumed to
 *    be handled by backend processes or administrators.
 * 3. Open Creation for Applicants: Any authenticated user can submit an application
 *    (`create` an applicant document). This allows for a simple application
 *    process without requiring a pre-existing user profile document.
 * 4. Collection Group Queries: A separate rule on `/{path=**}/applicants/{applicantId}`
 *    is used to allow admins to perform collection group queries across all `applicants`
 *    subcollections. This is essential for the admin dashboard functionality.
 *
 * Denormalization for Authorization:
 * The `Applicant` document contains a `trainingModuleId` field, which duplicates
 * the ID from its parent path. This is a deliberate design choice that allows
 * rules to validate the relationship on creation without needing extra `get()` calls,
 * improving performance and security.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Variables ---
    // The UID of the designated administrator.
    let ADMIN_UID = '9Vl6oTot93b9TH442xYCDLbMLs32';

    // --- Helper Functions ---

    /**
     * Checks if a user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the authenticated user has administrative privileges by
     * comparing their UID against a hardcoded value.
     */
    function isAdmin() {
      return isSignedIn() && request.auth.uid == ADMIN_UID;
    }

    /**
     * On create, validates that the applicant document's internal `trainingModuleId`
     * matches the ID of the parent collection in the path.
     * This enforces relational integrity between an application and its training module.
     */
    function incomingDataHasValidTrainingModuleId(moduleId) {
      return request.resource.data.trainingModuleId == moduleId;
    }

    /**
     * @description
     *   Manages access to Training Module documents. These are public for anyone
     *   to read, but all write operations (create, update, delete) are restricted
     *   to administrators.
     * @path
     *   /trainingModules/{trainingModuleId}
     */
    match /trainingModules/{trainingModuleId} {
      allow read: if true;
      allow write: if isAdmin();

      /**
       * @description
       *   Manages create access for Applicant documents within a training module.
       *   Any signed-in user can submit an application. Applications are immutable
       *   and cannot be changed or deleted by clients. Read access is handled
       *   by the collection group rule below.
       * @path
       *   /trainingModules/{trainingModuleId}/applicants/{applicantId}
       */
      match /applicants/{applicantId} {
        allow create: if isSignedIn() && incomingDataHasValidTrainingModuleId(trainingModuleId);
        // Read (get, list) and other write (update, delete) operations are implicitly denied
        // at this path, but can be granted by other rules (like the collection group rule below).
      }
    }

    /**
     * @description
     *   Allows administrators to read any document in any 'applicants' collection
     *   group. This is necessary for the admin dashboard to fetch all applicants
     *   across all training modules.
     * @path
     *   /{path=**}/applicants/{applicantId}
     */
    match /{path=**}/applicants/{applicantId} {
       allow read: if isAdmin();
       // This rule only grants read access. Writes must be defined on more specific paths
       // to prevent any authenticated admin from creating an applicant document anywhere.
    }
  }
}
